'use strict';var numItems="",subsType,subsQty,availableQuantities=availableQuantities||[],availableTerms=availableTerms||[],availableScents=availableScents||[],availableAddons=availableAddons||[],availableProducts=availableProducts||[],SubscribeModel=BBSafe.Model.extend({}),Quantity=BBSafe.Model.extend({}),Term=BBSafe.Model.extend({}),Scent=BBSafe.Model.extend({initialize:function(){this.listenTo(BBSafe,"quantity:toSelect",this.updateQuantity)},updateQuantity:function(a){this.numToSelect=a.numChoices;
this.numSelected=a.numSelected},increaseQuantity:function(){this.canAdd=!0;this.numSelected>=this.numToSelect&&(this.canAdd=!1);this.canAdd&&this.set("qty",this.get("qty")+1)},decreaseQuantity:function(){0!==this.get("qty")&&(this.set("qty",this.get("qty")-1),this.canAdd=!0)}}),Addon=BBSafe.Model.extend({}),Quantities=BBSafe.Collection.extend({model:Quantity}),Terms=BBSafe.Collection.extend({model:Term}),Scents=BBSafe.Collection.extend({model:Scent}),Addons=BBSafe.Collection.extend({model:Addon}),
TemplatedView=BBSafe.View.extend({template_id:"",render:function(){this.$el.html(_.template($(this.template_id).html())(this.model.toJSON()))},initialize:function(){_.bindAll(this,"render");this.model.on("change",this.render,this)}}),QuantityView=TemplatedView.extend({events:{"click .btn-product-select":"quantitySelected"},template_id:"#product_template",quantitySelected:function(a){a.preventDefault();this.model.set("selected",!0);BBSafe.trigger("quantity:selectionChanged",this.model)}}),QuantitiesView=
BBSafe.View.extend({el:$(".product-template-holder"),initialize:function(){_.bindAll(this,"render");this.collection.on("add",this.render);this.listenTo(BBSafe,"quantity:selectionChanged",this.quantitySelectionChanged)},addQuantity:function(a){a=new QuantityView({model:a});a.render();this.$el.append(a.el)},updateSelectedQty:function(){this.currentQty=this.collection.filter(function(a){return!0===a.get("selected")})},quantitySelectionChanged:function(a){this.currentQty[0].set("selected",!1);a.set("selected",
!0);this.currentQty[0]=a;BBSafe.trigger("quantity:Reset")},render:function(){this.collection.forEach(this.addQuantity,this);this.updateSelectedQty()}}),TermView=TemplatedView.extend({events:{"click .btn-term-select":"termSelected"},template_id:"#term_template",termSelected:function(a){a.preventDefault();BBSafe.trigger("term:selectionChanged",this.model)}}),TermsView=BBSafe.View.extend({el:$(".term-template-holder"),initialize:function(){_.bindAll(this,"render");this.collection.on("add",this.render);
this.listenTo(BBSafe,"term:selectionChanged",this.termSelectionChanged)},addTerm:function(a){a=new TermView({model:a});a.render();this.$el.append(a.el)},updateSelectedTerm:function(){this.currentTerm=this.collection.filter(function(a){return!0===a.get("selected")})},termSelectionChanged:function(a){this.currentTerm[0].set("selected",!1);a.set("selected",!0);this.currentTerm[0]=a;BBSafe.trigger("quantity:Reset")},render:function(){this.collection.forEach(this.addTerm,this);this.updateSelectedTerm()}}),
ScentView=BBSafe.View.extend({template:_.template($("#scent_template").html()),events:{"click .qty-up":"increaseQuantity","click .qty-down":"decreaseQuantity"},initialize:function(){_.bindAll(this,"render");this.model.on("change",this.render,this)},increaseQuantity:function(a){a.preventDefault();this.model.increaseQuantity()},decreaseQuantity:function(a){a.preventDefault();this.model.decreaseQuantity()},render:function(){var a=this.model.toJSON();this.$el.html(this.template(a))}}),ScentsView=BBSafe.View.extend({el:$(".scent-template-holder"),
initialize:function(){_.bindAll(this,"render");this.collection.on("add",this.render);this.listenTo(BBSafe,"quantity:Reset",this.resetScents)},addScent:function(a){a=new ScentView({model:a});a.render();this.$el.append(a.el)},resetScents:function(){this.collection.forEach(function(a){a.set("qty",0)})},getScentChoices:function(){return this.collection.filter(function(a){return 0<a.get("qty")})},render:function(){this.collection.forEach(this.addScent,this)}}),ChosenScentView=BBSafe.View.extend({template:_.template($("#chosen_scent_template").html()),
events:{"click .remove":"removeScent"},initialize:function(){_.bindAll(this,"render");this.model.on("change",this.render,this)},removeScent:function(){this.model.decreaseQuantity()},render:function(){var a=this.model.toJSON();return this.$el.html(this.template(a)),this}}),ChosenScentsView=BBSafe.View.extend({el:$(".chosen-scent-template-holder"),initialize:function(){_.bindAll(this,"render");this.collection.on("change",this.render)},addScent:function(a){a=new ChosenScentView({model:a});this.$el.append(a.render().el)},
checkQty:function(){var a=this.collection.map(function(a){return a.get("qty")});this.totalScentSelected=_.reduce(a,function(a,c){return a+c},0)},reset:function(){this.collection.map(function(a){return a.clear()});this.$el.empty()},setNumChoices:function(a){this.numChoices=a;this.updateDOM()},updateDOM:function(){var a=this.numChoices,b=this.totalScentSelected||0,c="("+b+" out of "+a+")";$(".scents-quantity").html(c);BBSafe.trigger("quantity:toSelect",{numChoices:a,numSelected:b})},render:function(){this.$el.empty();
this.collection.filter(function(a){return 0!==a.get("qty")}).forEach(this.addScent,this);this.checkQty();this.updateDOM()}}),ChosenScentsPlaceholderView=BBSafe.View.extend({el:$(".chosen-scent-placeholder"),placeholder:_.template($("#chosen_scent_placeholder").html()),initialize:function(){this.listenTo(BBSafe,"quantity:toSelect",this.updateQuantity)},updateQuantity:function(a){this.$el.empty();var b=this.collection.filter(function(a){return 1<a.get("qty")}).map(function(a){return a.get("qty")});
b=_.reduce(b,function(a,b){return a+b},0);a=a.numChoices-(0<b?b-1:0);for(b=0;a>b;b++)this.$el.append(this.placeholder)}}),AddonView=TemplatedView.extend({template_id:"#addon_template",events:{"click .btn-addon-select":"addonSelected"},addonSelected:function(a){a.preventDefault();this.model.set("selected",!1===this.model.get("selected"))}}),AddonsView=BBSafe.View.extend({el:$(".addon-template-holder"),initialize:function(){_.bindAll(this,"render");this.collection.on("add",this.render)},addAddons:function(a){var b=
new AddonView({model:a});switch(b.render(),a.get("category")){case "most-popular":this.$el.find(".addon-most-polular").append(b.el);break;case "cologne":this.$el.find(".addon-cologne").append(b.el);break;case "shave":this.$el.find(".addon-shave").append(b.el);break;case "hair":this.$el.find(".addon-hair").append(b.el);break;default:this.$el.append(b.el)}},prePopulateAddon:function(a){var b=this;a.forEach(function(a){var c=b.collection.filter(function(b){return b.get("name")===a});"0"!=c[0].get("outofstock")&&
c[0].set("selected",!0)})},getAddonChoices:function(){var a=[];return this.collection.forEach(function(b){!0===b.get("selected")&&a.push({id:b.get("id"),is_single_purchasable:"True"===b.get("is_single_purchasable")})}),a},render:function(){this.collection.forEach(this.addAddons,this);this.prePopulateAddon(["Soap Saver"])}}),SubscribeView=BBSafe.View.extend({el:$(document),events:{"click .submit-subscription":"submitClicked"},initialize:function(){_.bindAll(this,"render");var a=new Quantities,b=new Terms,
c=new Scents,e=(new ChosenScentsView({collection:c}),new Addons);this.quantitiesView=new QuantitiesView({collection:a});this.termsView=new TermsView({collection:b});this.scentsView=new ScentsView({collection:c});this.chosenScentsView=new ChosenScentsView({collection:c});this.addonsView=new AddonsView({collection:e});this.scentsPlaceholderView=new ChosenScentsPlaceholderView({collection:c});a.reset(availableQuantities);b.reset(availableTerms);c.reset(availableScents);e.reset(availableAddons);this.listenTo(BBSafe,
"quantity:selectionChanged",this.updateQuantity);this.listenTo(BBSafe,"term:selectionChanged",this.updateTermType);this.model.set("available_products",availableProducts);this.model.set("qty",2);this.model.set("term_type",3);this.updateSelectedProduct()},render:function(){this.quantitiesView.render();this.termsView.render();this.scentsView.render();this.updateAvailableScents();this.addonsView.render();$(".loading").removeClass("active")},calcNumChoices:function(){var a=this.model.get("qty"),b=this.model.get("term_type");
return a*b},updateQuantity:function(a){a.get("qty")!=this.model.get("qty")&&this.model.set("qty",a.get("qty"));this.updateAvailableScents();this.updateSelectedProduct()},updateTermType:function(a){a!=this.model.get("term_type")&&this.model.set("term_type",a.get("term_type"));this.updateAvailableScents();this.updateSelectedProduct()},updateSelectedProduct:function(){var a=_.findWhere(this.model.get("available_products"),{qty:this.model.get("qty"),term_type:this.model.get("term_type")});subsType=this.model.get("term_type");
subsQty=this.model.get("qty");a&&this.model.set("selected_product",a)},updateAvailableScents:function(){this.chosenScentsView.setNumChoices(this.calcNumChoices())},getChosenScentMetadata:function(){var a={},b=this.scentsView.getScentChoices(),c=this.calcNumChoices(),e=b.map(function(a){return a.get("qty")}),d=_.reduce(e,function(a,b){return a+b},0);e=new Scent({sku:"squatch-picks",qty:1});if(d<c)for(c-=d,d=0;d<c;++d)b.push(e);b.map(function(a){var c=a.get("qty");if(1<c)for(var d=0;d<c-1;++d)b.push(a)});
console.log("scents",b);for(d=0;d<b.length;++d)a["mf:cart.survey.scent_IDX_.string".replace("_IDX_",d+1)]=b[d].get("sku");return a},submitClicked:function(a){a.preventDefault();$(".loading").html("Hang on a sec, Squatch is prepping your order.").addClass("active");var b={products:[]};b.products.push({product_id:this.model.get("selected_product").id,term_cycles:1,quantity:1});_.each(this.addonsView.getAddonChoices(),function(a){b.products.push({product_id:a.id,term_cycles:a.is_single_purchasable?null:
1,quantity:1})});b.products[0].metadata=this.getChosenScentMetadata();b.clear_cart=!0;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(b),dataType:"json",url:"/cart/add",success:function(a){window.location="/checkout"}})}});$(".subscribe_btn").click(function(){$(window).scrollTop($(".panel-collapse.collapse.in").offset().top-90)});var subscribeView=new SubscribeView({model:new SubscribeModel});subscribeView.render();
